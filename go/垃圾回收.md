## Q:什么是根对象

跟对象是垃圾回收器在标记过程时最先检查的对象，包括：

- 全局变量：在编译期就能确定的那些存在于程序整个生命周期的变量。
- 执行栈：每个goroutine都包含自己的执行栈，这些执行栈包含**栈上的变量**及指向**分配的堆内存区块的指针**。
- 寄存器：寄存器的值可能标识一个指针，参与计算的这些指针可能指向某些赋值器分配的堆内存区块。

## Q:三色标记法是什么？

- 白色对象(可能死亡)：未被回收器访问到的对象。收回开始阶段，所有对象均为白色，回收结束后，白色对象均不可达。
- 灰色对象(波面)：已被回收器访问到的对象，单回收期需要对其中一个或多个指针进行扫描，因为他们可能还指向白色对象。
- 黑色对象(确定存活)：已被回收器访问到的对象，其中所有对象字段都已被扫描，黑色对象中任何一个指针都不可能直接指向白色对象。

这种三种不变性所定义的回收过程其实是一个波面不断前进的过程(像水波)，这个波面是灰色对象，它也是黑色对象和白色对象的边界。

垃圾回收开始的时候只有白色对象，随着标记过程开始进行时，灰色对象开始出现(着色)，这时波面便开始扩大。当一个对象中所有子节点均完成扫描时，会被标记为黑色。整个堆遍历完成时，只剩下黑色和白色对象，这时的黑色对象为可达对象，即存货；白色对象不可达，即死亡。



在go内部对象并没有保存颜色的属性, 三色只是对它们的状态的描述,

- 白色的对象在它所在的span的gcmarkBits中对应的bit为0

- 灰色的对象在它所在的span的gcmarkBits中对应的bit为1, 并且对象在标记队列中,

- 黑色的对象在它所在的span的gcmarkBits中对应的bit为1, 并且对象已经从标记队列中取出并处理.

gc完成后, gcmarkBits会移动到allocBits然后重新分配一个全部为0的bitmap, 这样黑色的对象就变为了白色.



## Q: STW是什么？

STW 是 StoptheWorld 的缩写，是指在垃圾回收过程中为了保证实现的正确性、防止无止境的内存增长等问题而不可避免的需要**停止赋值器进一步操作对象图**的一段过程。



## Q:并发标记清除法的难点是什么？

如何保证标记与清楚过程的正确性。

如下图：由于并发回收的存在，可能会在回收器对对象图扫描的间隙有赋值器修改对象图。使得某些可访达的子节点被错误回收。

![gc](/Users/shijiaxiong/web/interview_knowledge/go/static/640.png)

## Q:什么是写屏障、混合写屏障，如何实现？

混合写屏障：

- 对要引用的双方进行着色。
- 缺点：着色成本是双倍的，编译器需要插入的代码也是成倍的。

```go
// 混合写屏障
func HybridWritePointerSimple(slot *unsafe.Pointer, ptr unsafe.Pointer) {
    shade(*slot)
    shade(ptr)
    *slot = ptr
}
```



## Q:有了GC为什么还会发生内存泄漏？

- 预期能被快速释放的内存因被根对象引用而没有得到迅速的释放。比如某个变量被附在了全局对象上，可能永远不会被释放。

  ```go
  
  var cache = map[interface{}]interface{}{}
  
  func keepalloc() {
    for i := 0; i < 10000; i++ {
      m := make([]byte, 1<<10)
      cache[i] = m
    }
  }
  ```


- goroutine泄漏

## Q:触发 GC 的时机是什么？

> runtime/mgc.go

- `gcTriggerHeap`当前分配的内存达到一定值就触发GC。
- `gcTriggerTime`当超过两分钟没有产生任何 GC 时，强制触发 GC。
- `gcTriggerCycle`调用 runtime.GC 来触发 GC。

主动：runtime.GC

被动：使用系统监控，当超过两分钟没有产生任何 GC 时，强制触发 GC。前分配的内存达到一定值就触发GC。

## Q:如果内存分配速度超过了标记清除的速度怎么办？

当 Goroutine 调用 `runtime.mallocgc`分配新对象时，会暂停分配内存过快的那些 goroutine，并将其转去执行一些辅助标记（Mark Assist）和清扫(Sweep)的工作，从而达到放缓继续分配、辅助 GC 的标记工作的目的。

## Q:GC 调优

- 减少
- 控制
- 复用





## Reference

[GO GC 20问](https://mp.weixin.qq.com/s/o2oMMh0PF5ZSoYD0XOBY2Q)

[GO GC实现 源码分析](https://www.cnblogs.com/zkweb/p/7880099.html)

