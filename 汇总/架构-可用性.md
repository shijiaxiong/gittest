## 可用性

### 隔离

- 服务隔离：
  - 动静隔离：
    - 应用：mysql数据库表按使用频率做动静隔离；架构中的图片、静态资源做缓存加速。
  - 读写分离：
  - 按类型拆分：比如电商的查询、发货服务拆分。
- 轻重隔离：
  - 快慢隔离：按请求耗时去拆分服务。
  - 热点隔离：将经常访问的数据做缓存。
- 物理隔离
  - 线程隔离
  - 进程隔离
  - 集群隔离

### 超时控制！

- 内部服务提供者要尽量设置 95线、99线，防止调用者出现意外超时。
- 具体实现：
  - 进程内超时控制：go的`context.WithTimeout`
  - 服务间的超时控制：grpc客户端发起请求时，如果设置了带 timeout 的ctx，则会导致底层 HTTP2 HEADERS Frame 中追加 `grpc-timeout` 字段。hprose则要自己计算timeout时间并加入到参数中。

### 过载保护！！！

- go-zero中当CPU>90%的时候触发过载保护。在程序启动程中执行init函数，启动协程，每隔250ms进行一次统计。过载保护基于滑动窗口可以防止毛刺，有冷却时间防止抖动。

利特尔法则



### 限流（集群、服务）！

#### 令牌桶

- 令牌桶算法是桶里面放了一些令牌，每来一个请求就在桶里拿一个令牌，如果没有令牌它就可以等待，令牌满了就不再往里面加令牌。这样方法基本上也可以达到一个限流的目的。

#### 漏桶算法

- 请求先进入到漏桶里，漏桶以一定速率出水，当桶的容量满了之后就会抛弃请求。

#### 令牌桶和漏桶的区别

- 漏桶的处理速率比较恒定，令牌桶允许出现在桶范围内的小爆发。
- 两者都是单机限流，他们的难点都是桶容量的设定。

#### 分布式限流

令牌桶

使用redis存储令牌，批量生成令牌，减少redis的请求次数。



### 降级！

- 通过降级回复来减少工作量，或者丢弃不重要的请求。
- 自动降级的要点：
  - 采用哪个指标作为流量评估和优雅降级的决定性指标(CPU、延迟、队列长度、线程数量、错误等)
  - 当服务进入降级模式时，需要执行什么动作。
  - 流量抛弃或者优雅降级应该在服务的哪一层实现?是否需要在整个服务的每一层都实现，还是可以选择某个高层面的关键节点来实现?

### 重试！

#### 简单重试

- 请求失败后，程序执行retry，对下游服务再次发起请求。下游业务支持幂等才可以重试，否则可能导致数据重复。
- **缺点：** 服务出现问题后，会带来双倍流量，冲垮服务。多层级重试，放大流量引起雪崩。
- **改进方法：** 统计成功率，当成功率过低，则不做重试，直接返回错误。重试应该只在失败的这层进行，重试依然失败的情况下应该返回约定的错误码和错误信息，避免流量放大的情况。

#### 主备服务自动切换

> 对于有负载均衡的内部服务，应该只用简单重试就可以了。

- 搭建两套服务，请求服务A失败，则转向请求服务B。
- **缺点：** 资源浪费、如果A宕机，服务全部转向B，B可能会被打挂。

### 负载均衡！！！

#### 轮询

- 所有请求依次发到每台服务器上，适合服务器硬件相同的情况。
- 优点：服务器请求数目相同。
- 缺点：服务器配置不同的情况不适用。

#### 最少链接

- 将请求分配到连接数最少的服务器（目前处理请求最少的服务器）
- 优点：根据服务器当前的请求处理情况，动态分配。
- 缺点：算法实现复杂，需要监控服务器请求连接数。

#### hash 源地址散列

- 根据IP地址进行Hash计算，得到IP地址。
- 优点：将来自同一IP地址的请求，同一会话期内，转发到相同的服务器；实现会话粘滞。

#### go-zero 的 P2C算法

- Pick of 2 choices 二选一，即从可用节点列表中随机选择两个节点，计算它们的负载率load，选择负载率较低的进行请求。



### Reference

[小米- GRPC超时传递](https://app.yinxiang.com/shard/s43/nl/13675070/be91c6cc-f067-40df-a581-c66d274ed5ed)

[腾讯 运营平台容错性建设 重试、超时、降级、隔离](https://app.yinxiang.com/shard/s43/nl/13675070/f39beab3-c1f0-4157-a457-2a80d7c2ac10)

[服务稳定性](https://app.yinxiang.com/shard/s43/nl/13675070/4acf10c7-540a-4821-a474-ae50ecc3ee79)

[go-zero过载保护](https://app.yinxiang.com/shard/s43/nl/13675070/49e82735-73f1-40c3-abbd-e5b8e0faf2fe)

[限流算法实践 - 分布式限流](https://app.yinxiang.com/shard/s43/nl/13675070/d8d9d56c-d12f-465a-aafb-8428c4b7b19b)

[小米限流秒杀架构](https://app.yinxiang.com/shard/s43/nl/13675070/bfd131f7-1f28-4cdf-91cf-699e86cdaca3)



## 负载均衡

#### 四层负载均衡

- 四层负载均衡工作在OSI的传输层。
- 实现原理：使用IP加端口的方式进行路由转发。
- 实现方式：通过报文中的IP地址和端口，再加上负载均衡设备所采用的负载均衡算法，最终确定选择后端哪台下游服务器。以TCP为例，客户端向负载均衡发送SYN请求建立第一次连接，通过配置的负载均衡算法选择一台后端服务器，并且将报文中的IP地址信息修改为后台服务器的IP地址信息，因此**TCP三次握手连接是与后端服务器直接建立起来的。**
- 常见设备：LVS。

#### 七层负载均衡

- 七层负载均衡工作在OSI的应用层。
- 实现原理：一般是基于请求URL地址的方式进行代理转发。
- 实现方式：七层服务均衡在应用层选择服务器，只能先与负载均衡设备进行TCP连接，**然后负载均衡设备再与后端服务器建立另外一条TCP连接通道**。因此，七层设备在网络性能损耗会更多一些。
- 常见设备：Nginx



#### 七层与四层的安全

四层负载均衡与服务器直接建立起TCP连接，很容易遭受SYN Flood攻击。SYN Flood是一种广为人知的DDoS（分布式拒绝服务攻击）的方式之一，这是一种利用TCP协议缺陷，发送大量伪造的TCP连接请求，从而使得被攻击方资源耗尽的攻击方式。从技术实现原理上可以看出，四层负载均衡很容易将垃圾流量转发至后台服务器，而七层设备则可以过滤这些恶意并清洗这些流量，但要求设备本身具备很强的抗DDOS流量的能力。
