## Q:一条MySQL更新语句的执行过程是什么样的？

> update t set b = 200 where id = 2

#### Server 层

- 客户端发出更新语句，并向MySQL服务端请求建立连接。
- MySQL Server层的**连接器**负责与客户端建立连接，做权限验证，并维持和管理连接。
- 清空表T上的所有查询缓存结果。在8.0及以后版本去掉了查询缓存。
- 分析器去做词法和语法分析，知道MySQL语句要做什么。
- 优化器去选择使用合适的索引。
- 执行器调用InnoDB引擎的接口来执行语句。

#### 引擎层

- InnoDB引擎首先开启事务，获得一个事务ID。
- 根据执行的语句生成一个反向的语句，用于提交失败后回滚。
- 将这条反向语句写入undo log，得到回滚指针，并且更新这个数据行的回滚指针和事务id。
- 根据索引去B+树中找到这一行数据（如果是普通索引，查到不符合条件的索引，会把所有数据查找出来，唯一性索引查到第一个数据就可以了）
- 判断数据页是否在内存中
  - 数据在内存中。普通索引会直接更新内存中的数据页；唯一索引会判断更新后是否会引起数据冲突(不能破坏索引的唯一性)。不会的话就更新内存中的数据。
  - 数据不再内存中。如果是普通索引，将对数据页的更新操作记录到change buffer，暂时不更新到磁盘。change buffer会在空闲时异步更新到磁盘。如果是唯一索引，因为需要保证更新后的唯一性，所以不能延迟更新，必须把数据页从磁盘加载到内存，然后判断更新后是否会数据冲突，不会的话就更新数据页。
- 将对数据页的更改写入到redo log，将redo log设置为prepare状态。
- 通知MySQL server已经更新操作写入到redo log 了，随时可以提交，将执行的SQL写入到bin log日志，将redo log改成commit状态，事务提交成功。

![](./picture/updateprocess.png)

